{"componentChunkName":"component---src-templates-content-template-js","path":"/osa3/sovellus_internetiin","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Yhdistetään seuraavaksi <a href=\"/fullstack/osa2\">osassa 2</a> tekemämme frontend omaan backendiimme. </p>\n<p>Edellisessä osassa backendinä toiminut json-server tarjosi muistiinpanojen listan osoitteessa <a href=\"http://localhost:3001/notes\">http://localhost:3001/notes</a> frontendin käyttöön. Backendimme urlien rakenne on hieman erilainen, muistiinpanot löytyvät osoitteesta <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a>, eli muutetaan frontendin tiedostossa <i>src/services/notes.js</i> määriteltyä muuttujaa <em>baseUrl</em> seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:3001/api/notes'</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAll</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span> getAll<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> update <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Frontendin tekemä GET-pyyntö osoitteeseen <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a> ei jostain syystä toimi:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/6e29b/3ae.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA80lEQVQY0x2Ja2+CMBhG+f//yw/OTBcuSlEDbrQvpVdehJaBZbjk5OTJeSIhJAAIqR41Z9A2DSil2rbVWm9dSlnTWoCAqmHAtqtDRK0N/GDfRWVVNrzR1nIpgXMAZq0JYQnhtXmavJBCazUOT+cG70bvR+dGRCtlGyka6/prsndv76gImptVpFMF6uJp74O+Tub28myZYHb017PZs3XmRlzhO45Clrw5HUMau4J0Wdonsc0SvfmceXJ5kXwheX8tkOT2nA75ZSmIKUv1qKIQJ+tutx4OuN/j/qP7PJoknShbsV9Nt9p/jH2zDf32QGlf07HhfwabEi/Uh6sZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3ae\"\n        title=\"3ae\"\n        src=\"/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/fcda8/3ae.png\"\n        srcset=\"/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/12f09/3ae.png 148w,\n/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/e4a3f/3ae.png 295w,\n/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/fcda8/3ae.png 590w,\n/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/efc66/3ae.png 885w,\n/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/c83ae/3ae.png 1180w,\n/fullstack/static/da88e17cb078c89a6e7ba30d61fab0e6/6e29b/3ae.png 1610w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Mistä on kyse? Backend toimii kuitenkin selaimesta ja postmanista käytettäessä ilman ongelmaa.</p>\n<h3>Same origin policy ja CORS</h3>\n<p>Kyse on asiasta nimeltään CORS eli Cross-origin resource sharing. <a href=\"https://en.wikipedia.org/wiki/Cross-origin_resource_sharing\">Wikipedian</a> sanoin</p>\n<blockquote>\n<p><i>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources (e.g. fonts) on a web page to be requested from another domain outside the domain from which the first resource was served. A web page may freely embed cross-origin images, stylesheets, scripts, iframes, and videos. Certain \"cross-domain\" requests, notably Ajax requests, are forbidden by default by the same-origin security policy.</i></p>\n</blockquote>\n<p>Lyhyesti sanottuna meidän kontekstissa kyse on seuraavasta: websovelluksen selaimessa suoritettava Javascript-koodi saa oletusarvoisesti kommunikoida vain samassa <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">originissa</a> olevan palvelimen kanssa. Koska palvelin on localhostin portissa 3001 ja frontend localhostin portissa 3000, niiden origin ei ole sama.</p>\n<p>Korostetaan vielä, että <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\">same origin policy</a> ja CORS eivät ole mitenkään React- tai Node-spesifisiä asioita, vaan yleismaailmallisia periaatteita Web-sovellusten toiminnasta.</p>\n<p>Voimme sallia muista <i>origineista</i> tulevat pyynnöt käyttämällä Noden <a href=\"https://github.com/expressjs/cors\">cors</a>-middlewarea.</p>\n<p>Asennetaan backendiin <i>cors</i> komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> cors --save</code></pre></div>\n<p>Otetaan middleware käyttöön toistaiseksi sellaisella konfiguraatiolla joka sallii kaikista origineista tulevat pyynnöt kaikkiin backendin express routeihin:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> cors <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cors'</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Nyt frontend toimii! Tosin muistiinpanojen tärkeäksi muuttavaa toiminnallisuutta backendissa ei vielä ole.</p>\n<p>CORS:ista voi lukea tarkemmin esim. <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS\">Mozillan sivuilta</a>.</p>\n<h3>Sovellus internettiin</h3>\n<p>Kun koko \"stäkki\" on saatu vihdoin kuntoon, siirretään sovellus internettiin. Käytetään seuraavassa vanhaa kunnon <a href=\"https://www.heroku.com\">Herokua</a>.</p>\n<blockquote>\n<p><i>Jos et ole koskaan käyttänyt herokua, löydät käyttöohjeita kurssin <a href=\"https://materiaalit.github.io/tsoha-18/viikko1/\">Tietokantasovellus</a>-materiaalista ja Googlaamalla...</i></p>\n</blockquote>\n<p>Lisätään backendin projektin juureen tiedosto <i>Procfile</i>, joka kertoo Herokulle, miten sovellus käynnistetään</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">web: node index.js</code></pre></div>\n<p>Muutetaan tiedoston <i>index.js</i> lopussa olevaa sovelluksen käyttämän portin määrittelyä seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token number\">3001</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Nyt käyttöön tulee <a href=\"https://en.wikipedia.org/wiki/Environment_variable\">ympäristömuuttujassa</a> <em>PORT</em> määritelty portti tai 3001, jos ympäristömuuttuja <em>PORT</em> ei ole määritelty. Heroku konfiguroi sovelluksen portin ympäristömuuttujan avulla.</p>\n<p>Tehdään projektihakemistosta git-repositorio ja lisätään <i>.gitignore</i>, jolla on seuraava sisältö</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node_modules</code></pre></div>\n<p>Luodaan heroku-sovellus komennolla <em>heroku create</em>, tehdään sovelluksen hakemistosta git-repositorio, commitoidaan koodi ja siirretään se Herokuun komennolla <em>git push heroku master</em>.</p>\n<p>Jos kaikki meni hyvin, sovellus toimii:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/fde66/25ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+klEQVQoz51QXW/DIAzM//9161OnautUDQKkQIAQvgxkbruX9qXdrMOykM/23ZBzhlpDjFxMhFI6jggsCGUj4/ipZ7OG6KwrnJeUcm2B0OI9soaSc+99+1cM+HDX4fAh/VksfPKTzz6U8MrEAZuklMevo9KTX/Ra1gQxQXqJXFFwCCmWvvW2IaPXXltv0KDUUlt9cjYh5G23+5an0/mTOUYsYW500c1xRgm3vn6di7gjA8CyeGMsOrkV+LNhSik2Cg9epVmtyiSjgnLpstkma6LB/ZgRIYdHshBi/77nkmor9JUwBw21oOwb0IXf4t6Ci2Fo7CW3B0XP4weDZUdQOEy/NwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"25ea\"\n        title=\"25ea\"\n        src=\"/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/fcda8/25ea.png\"\n        srcset=\"/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/12f09/25ea.png 148w,\n/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/e4a3f/25ea.png 295w,\n/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/fcda8/25ea.png 590w,\n/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/efc66/25ea.png 885w,\n/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/c83ae/25ea.png 1180w,\n/fullstack/static/7e52f36bb453e8d8a730d4b2812764c1/fde66/25ea.png 1574w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Jos ei, vikaa voi selvittää herokun lokeja lukemalla, eli komennolla <em>heroku logs</em>.</p>\n<blockquote>\n<p><strong>HUOM</strong> ainakin alussa on järkevää tarkkailla Herokussa olevan sovelluksen lokeja koko ajan. Parhaiten tämä onnistuu antamalla komento <em>heroku logs -t</em>, jolloin logit tulevat konsoliin sitä mukaan kun palvelimella tapahtuu jotain.</p>\n</blockquote>\n<p>Myös frontend toimii Herokussa olevan backendin avulla. Voit varmistaa asian muuttamalla frontendiin määritellyn backendin osoitteen viittaamaan <i><a href=\"http://localhost:3001\">http://localhost:3001</a></i>:n sijaan Herokussa olevaan backendiin.</p>\n<p>Seuraavaksi herää kysymys: miten saamme myös frontendin internettiin? Vaihtoehtoja on useita, mutta käydään seuraavaksi läpi yksi niistä.</p>\n<h3>Frontendin tuotantoversio</h3>\n<p>Olemme toistaiseksi suorittaneet React-koodia <i>sovelluskehitysmoodissa</i>, missä sovellus on konfiguroitu antamaan havainnollisia virheilmoituksia, päivittämään koodiin tehdyt muutokset automaattisesti selaimeen ym.</p>\n<p>Kun sovellus viedään tuotantoon, täytyy siitä tehdä <a href=\"https://reactjs.org/docs/optimizing-performance.html#use-the-production-build\">production build</a>\neli tuotantoa varten optimoitu versio.</p>\n<p><i>create-react-app</i>:in avulla tehdyistä sovelluksista saadaan muodostettua tuotantoversio komennolla <a href=\"https://github.com/facebookincubator/create-react-app#npm-run-build-or-yarn-build\"><em>npm run build</em></a>.</p>\n<p>Suoritetaan nyt komento <i>frontendin projektin juuressa</i>.</p>\n<p>Komennon seurauksena syntyy hakemiston <i>build</i> (joka sisältää jo sovelluksen ainoan html-tiedoston <i>index.html</i>) sisään hakemisto <i>static</i>, minkä alle generoituu sovelluksen Javascript-koodin <a href=\"https://en.wikipedia.org/wiki/Minification_(programming)\">minifioitu</a> versio. Vaikka sovelluksen koodi on kirjoitettu useaan tiedostoon, generoituu kaikki Javascript yhteen tiedostoon, samaan tiedostoon tulee itseasiassa myös kaikkien sovelluksen koodin tarvitsemien riippuvuuksien koodi.</p>\n<p>Minifioitu koodi ei ole miellyttävää luettavaa. Koodin alku näyttää seuraavalta:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">!</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">function</span> <span class=\"token function\">r</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> n<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">,</span>i<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>l<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>a<span class=\"token operator\">=</span>r<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>c<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>s<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>c<span class=\"token operator\">&lt;</span>i<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>c<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>f<span class=\"token operator\">=</span>i<span class=\"token punctuation\">[</span>c<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token operator\">&amp;&amp;</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>n <span class=\"token keyword\">in</span> l<span class=\"token punctuation\">)</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>l<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">&amp;&amp;</span><span class=\"token function\">p</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">return</span> u<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span>a<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token keyword\">function</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> e<span class=\"token punctuation\">,</span>r<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>r<span class=\"token operator\">&lt;</span>u<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>r<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> t<span class=\"token operator\">=</span>u<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>n<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>i<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>t<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span> l<span class=\"token operator\">=</span>t<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token number\">0</span><span class=\"token operator\">!==</span>o<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span><span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>n<span class=\"token operator\">&amp;&amp;</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>r<span class=\"token operator\">--</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>e<span class=\"token operator\">=</span><span class=\"token function\">f</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>s<span class=\"token operator\">=</span>t<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">}</span><span class=\"token keyword\">var</span> n<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>o<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">2</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>u<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">function</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">return</span> n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span><span class=\"token keyword\">var</span> t<span class=\"token operator\">=</span>n<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>i<span class=\"token operator\">:</span>r<span class=\"token punctuation\">,</span>l<span class=\"token operator\">:</span><span class=\"token operator\">!</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>exports<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>l<span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">}</span>f<span class=\"token punctuation\">.</span>m<span class=\"token operator\">=</span>e<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span>c<span class=\"token operator\">=</span>n<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">d</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span>t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">o</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">)</span><span class=\"token operator\">||</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>r<span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>enumerable<span class=\"token operator\">:</span><span class=\"token operator\">!</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>get<span class=\"token operator\">:</span>t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">r</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"undefined\"</span><span class=\"token operator\">!==</span><span class=\"token keyword\">typeof</span> Symbol<span class=\"token operator\">&amp;&amp;</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token operator\">&amp;&amp;</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>value<span class=\"token operator\">:</span><span class=\"token string\">\"Module\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Staattisten tiedostojen tarjoaminen backendistä</h3>\n<p>Eräs mahdollisuus frontendin tuotantoon viemiseen on kopioida tuotantokoodi, eli hakemisto <i>build</i> backendin repositorion juureen ja määritellä backend näyttämään pääsivunaan frontendin <i>pääsivu</i>, eli tiedosto <i>build/index.html</i>.</p>\n<p>Aloitetaan kopioimalla frontendin tuotantokoodi backendin alle, projektin juureen. Omalla koneellani kopiointi tapahtuu frontendin hakemistosta käsin komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> -r build <span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/3/luento/notes-backend</code></pre></div>\n<p>Backendin sisältävän hakemiston tulee nyt näyttää seuraavalta:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/3c4c5437683d0ea2e206c80b39766136/37048/27ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.837837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAfUlEQVQI13WLuw7CMAwA01Aldt06CW0TrKTQhccIEows/P9HkYmhEjfccNIpKsXn5bm+3ufHZ1+YyIDBmLqDYIxKKUR0zlHtxqgN0FO7a2/z6b5eL/2IAMw8iszL0ac0MNfZAlhrtdbbuRPBnDVNAYcJIQQXgq9dN83P//gCnOsHkiLf1vMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"27ea\"\n        title=\"27ea\"\n        src=\"/fullstack/static/3c4c5437683d0ea2e206c80b39766136/fcda8/27ea.png\"\n        srcset=\"/fullstack/static/3c4c5437683d0ea2e206c80b39766136/12f09/27ea.png 148w,\n/fullstack/static/3c4c5437683d0ea2e206c80b39766136/e4a3f/27ea.png 295w,\n/fullstack/static/3c4c5437683d0ea2e206c80b39766136/fcda8/27ea.png 590w,\n/fullstack/static/3c4c5437683d0ea2e206c80b39766136/efc66/27ea.png 885w,\n/fullstack/static/3c4c5437683d0ea2e206c80b39766136/c83ae/27ea.png 1180w,\n/fullstack/static/3c4c5437683d0ea2e206c80b39766136/37048/27ea.png 1352w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Jotta saamme expressin näyttämään <i>staattista sisältöä</i> eli sivun <i>index.html</i> ja sen lataaman Javascriptin ym. tarvitsemme expressiin sisäänrakennettua middlewarea <a href=\"http://expressjs.com/en/starter/static-files.html\">static</a>.</p>\n<p>Kun lisäämme muiden middlewarejen määrittelyn yhteyteen seuraavan</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>tarkastaa Express GET-tyyppisten HTTP-pyyntöjen yhteydessä ensin löytyykö pyynnön polkua vastaavan nimistä tiedostoa hakemistosta <i>build</i>. Jos löytyy, palauttaa express tiedoston.</p>\n<p>Nyt HTTP GET -pyyntö osoitteeseen <i>www.palvelimenosoite.com/index.html</i> tai <i>www.palvelimenosoite.com</i> näyttää Reactilla tehdyn frontendin. GET-pyynnön esim. osoitteeseen <i>www.palvelimenosoite.com/notes</i> hoitaa backendin koodi.</p>\n<p>Koska tässä tapauksessa sekä frontend että backend toimivat samassa osoitteessa, voidaan React-sovelluksessa eli frontendin koodissa oleva palvelimen <em>baseUrl</em> määritellä <a href=\"https://www.w3.org/TR/WD-html40-970917/htmlweb.html#h-5.1.2\">suhteellisena</a> URL:ina, eli ilman palvelinta yksilöivää osaa:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'/api/notes'</span></span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getAll</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p>Muutoksen jälkeen frontendistä on luotava uusi production build ja kopioitava se backendin repositorion juureen.</p>\n<p>Sovellusta voidaan käyttää nyt <i>backendin</i> osoitteesta <a href=\"http://localhost:3001\">http://localhost:3001</a>:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/9685e/28e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA60lEQVQoz5VRi27DIAzk/7+r/9FMkBCckIBNyiMjqZupq9ROanecLIx85gyirjWnPHuUqjs3X0r3vA+XSMvlLYVPPq9l27bvA7XW7WOIkzzBAvu+c7L/E2K20zy7J+Vv7zfiECiEwG5LWXPOMUY2/+nNzjkYGKBUK6Vszg0AEAU+stau3Ohu4dWIQER7wN0BMGitpVTGACLdFtE4jlxjAEopD3GKMRBxZBl6jJfoPU52suMUwnI8wI31wNNEom71hxQo5XQUP+zx160s4bDVP2busdeoW9cOYTBkOt8BwUFOORrl2g47TPQqvgIlPkWfSRkLAQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"28e\"\n        title=\"28e\"\n        src=\"/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/fcda8/28e.png\"\n        srcset=\"/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/12f09/28e.png 148w,\n/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/e4a3f/28e.png 295w,\n/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/fcda8/28e.png 590w,\n/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/efc66/28e.png 885w,\n/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/c83ae/28e.png 1180w,\n/fullstack/static/f5d8aad803a0a13ea9b29fd705774ec8/9685e/28e.png 1336w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Sovelluksemme toiminta vastaa nyt täysin osan 0 luvussa <a href=\"/fullstack/osa0/#single-page-app\">Single page app</a> läpikäydyn esimerkkisovelluksen toimintaa.</p>\n<p>Kun mennään selaimella osoitteeseen <a href=\"http://localhost:3001\">http://localhost:3001</a> palauttaa palvelin hakemistossa <i>build</i> olevan tiedoston <i>index.html</i>, jonka sisältö hieman tiivistettynä on seuraava:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>React App<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/css/main.f9a47af2.chunk.css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>root<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/js/1.578f4ea1.chunk.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/static/js/main.104ca08d.chunk.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Sivu sisältää ohjeen ladata sovelluksen tyylit määrittelevän CSS-tiedoston, sekä kaksi <i>script</i>-tagia, joiden ansiosta selain lataa sovelluksen Javascript-koodin, eli varsinaisen React-sovelluksen.</p>\n<p>React-koodi hakee palvelimelta muistiinpanot osoitteesta <a href=\"http://localhost:3001/api/notes\">http://localhost:3001/api/notes</a> ja renderöi ne ruudulle. Selaimen ja palvelimen kommunikaatio selviää tuttuun tapaan konsolin välilehdeltä <i>Network</i>:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/10d53/29ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.10810810810811%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaElEQVQoz51SWYrcMBTU/Q8wEMgd5gIhkO+B5GcgxHYLu71osSxbm2XJknuep5OQjwxZiqKQHqonSnroOG7OWP756/D0PH/55tm0hrACvL9TWxf5GJ0LKW2MuVl3Q7mZbtYeYYlvd0CbO/8aiGqac779F5AU0lq7bZtzznv/j+ZZCiH4KxhjsB3HcVkWaLeFUyD+vu+/N+eUgfAye9xzPuAcLFKC6lmPIa5+fSsX4oYTRbhmTLHRcOkmYYSwgiyEKmo3e8QD7o8xhhB+KgAuQG3X1XVTNqS+NrgjdduVuGn7rh86QglQ0hkSSSlBISCEuitEQ8mbHNbgvZK8qGqM67K6XDDuB9Jc27bvBzqAAOFFwGD0dyil0PtP87uP8uGDfHyawUD4bJZFj9PChRonLSYl5Okxxr9i+wWoYnvFU0FTv+RpkpRQXba+6v2lt2Xrimsapje/6sd0nYNFKS3KAg9YKnUW/zRxL0ENrvJsudqhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"29ea\"\n        title=\"29ea\"\n        src=\"/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/fcda8/29ea.png\"\n        srcset=\"/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/12f09/29ea.png 148w,\n/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/e4a3f/29ea.png 295w,\n/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/fcda8/29ea.png 590w,\n/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/efc66/29ea.png 885w,\n/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/c83ae/29ea.png 1180w,\n/fullstack/static/6f63795c7abedc6d9afbc405f0642aeb/10d53/29ea.png 1724w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Kun sovelluksen \"internettiin vietävä\" tuotantoversio todetaan toimivan paikallisesti, commitoidaan frontendin tuotantoversio backendin repositorioon ja pushataan koodi uudelleen herokuun.</p>\n<p><a href=\"https://vast-oasis-81447.herokuapp.com/\">Sovellus</a> toimii moitteettomasti lukuunottamatta vielä backendiin toteuttamatonta muistiinpanon tärkeyden muuttamista:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/0f586/30ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQoz5WQ3W7DIAyF8/5P2LtKhUTNlmDAGDB/m9PdrFUmdZZ1dITOZ8tMvY3RB8W4fnxqPet5UXq+qVlUKW3AxpQppp/2RAhQ73cuhZkn5dSCSxvt6/81XffrZb2UWn6/jjHegjkxOowxCtBa672/SR6wANu2GTCi66MAgIiccyml8VwnsKT3fTfGHMY8jAVR4UMIMggRxYu+8JN8deHCmSmQtQ491lJfNvy52WeHGT17SxYIQg2hhMABGUVtsi47KnR+MzH57IWXqISOKJMYaZkiI6Rzy6fwN1YnDMUrsp6VAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"30ea\"\n        title=\"30ea\"\n        src=\"/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/fcda8/30ea.png\"\n        srcset=\"/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/12f09/30ea.png 148w,\n/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/e4a3f/30ea.png 295w,\n/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/fcda8/30ea.png 590w,\n/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/efc66/30ea.png 885w,\n/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/c83ae/30ea.png 1180w,\n/fullstack/static/cde873f94e045e8d1a07b4d4a1a59bf9/0f586/30ea.png 1498w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Sovelluksemme tallettama tieto ei ole ikuisesti pysyvää, sillä sovellus tallettaa muistiinpanot muuttujaan. Jos sovellus kaatuu tai se uudelleenkäynnistetään, kaikki tiedot katoavat.</p>\n<p>Tarvitsemme sovelluksellemme tietokannan. Ennen tietokannan käyttöönottoa katsotaan kuitenkin vielä muutamaa asiaa.</p>\n<h3>Frontendin deployauksen suoraviivaistus</h3>\n<p>Jotta uuden frontendin version generointi onnistuisi jatkossa ilman turhia manuaalisia askelia, lisätään uusia skriptejä backendin <i>package.json</i>-tiedostoon</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token property\">\"build:ui\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf build &amp;&amp; cd ../../osa2/materiaali/notes-new &amp;&amp; npm run build --prod &amp;&amp; cp -r build ../../../osa3/notes-backend/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"git push heroku master\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy:full\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run build:ui &amp;&amp; git add . &amp;&amp; git commit -m uibuild &amp;&amp; git push &amp;&amp; npm run deploy\"</span><span class=\"token punctuation\">,</span>    \n    <span class=\"token property\">\"logs:prod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"heroku logs --tail\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Skripteistä <em>npm run build:ui</em> kääntää ui:n tuotantoversioksi ja kopioi sen. <em>npm run deploy</em> julkaisee herokuun. </p>\n<p><em>npm run deploy:full</em> yhdistää nuo molemmat sekä lisää vaadittavat <i>git</i>-komennot versionhallinnan päivittämistä varten. Lisätään lisäksi oma skripti <em>npm run logs:prod</em> lokien lukemiseen, jolloin käytännössä kaikki toimii npm-skriptein.</p>\n<p>Huomaa, että skriptissä <i>build:ui</i> olevat polut riippuvat repositorioiden sijainnista.</p>\n<h3>Proxy</h3>\n<p>Frontendiin tehtyjen muutosten seurauksena on nyt se, että kun suoritamme frontendiä sovelluskehitysmoodissa, eli käynnistämällä sen komennolla <em>npm start</em>, yhteys backendiin ei toimi:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/07d7d/32ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoklEQVQoz5VS2ZLbIBDU//9cKseunZVXNyALxH0jyRk7eUhceXEXRXUN09NFQ3Vsx74fIUS6rv0wjgivQjrnudKZkKR13g/HWLpePWVp+aLUbMP+WZ+0VhXSiBhS9nJ7BeAHqDrevc1vPvnb66hKLN74FNNj3v6aGDxDDiF7G6w0Mm0plZS3DDvwWGIoAcg/ouP4I9ZRyiBXv4ooVFLcrzJKFZVOGupQZJ6ZbP7vnMtWSgkxlpwzuOaS051HH4CHxx7hGBpK2QClZKehNedSkY+PGWPStR2iwzACbYa5H6a6RRjPBGNKKcaYMaZ/QyoxI6UEFCva98baYLSwka2iabtT3TdNezqd6/oyTgjevut6mIQRGcZpHCc8X2EIjKtIPwTOvTZeSi8V56IG64UzCr9mpcsihRCcA185B4G11rn78t5XbELT5dMqtce0w3UxvZ4bNeKw8LjwMK9muhpMA2E3qh5R/xWYC0FZa5yDPMqxJUSbb++Xrz/Q+891Io6KLO2mfeHmIPxZ/JR+Mrb5fheTcz23I6SnyFKU3bW7+fTU/AvF6eep5Ow4ugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"32ea\"\n        title=\"32ea\"\n        src=\"/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/fcda8/32ea.png\"\n        srcset=\"/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/12f09/32ea.png 148w,\n/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/e4a3f/32ea.png 295w,\n/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/fcda8/32ea.png 590w,\n/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/efc66/32ea.png 885w,\n/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/c83ae/32ea.png 1180w,\n/fullstack/static/19026b5379d1feef11ecc20ca2f669a9/07d7d/32ea.png 1478w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Syynä tälle on se, että backendin osoite muutettiin suhteellisesti määritellyksi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'/api/notes'</span></code></pre></div>\n<p>Koska frontend toimii osoitteessa <i>localhost:3000</i>, menevät backendiin tehtävät pyynnöt väärään osoitteeseen <i>localhost:3000/api/notes</i>. Backend toimii kuitenkin osoitteessa <i>localhost:3001</i>.</p>\n<p>create-react-app:illa luoduissa projekteissa ongelma on helppo ratkaista. Riittää, että frontendin repositorion tiedostoon <i>package.json</i> lisätään seuraava määritelmä:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"dependencies\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    // <span class=\"token punctuation\">..</span>.\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"scripts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    // <span class=\"token punctuation\">..</span>.\n  <span class=\"token punctuation\">}</span>,\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token string\">\"proxy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http://localhost:3001\"</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Uudelleenkäynnistyksen jälkeen Reactin sovelluskehitysympäristö toimii <a href=\"https://facebook.github.io/create-react-app/docs/proxying-api-requests-in-development\">proxynä</a>. Jos React-koodi tekee HTTP-pyynnön palvelimen <i><a href=\"http://localhost:3000\">http://localhost:3000</a></i> johonkin osoitteeseen, joka ei ole React-sovelluksen vastuulla (eli kyse ei ole esim. sovelluksen Javascript-koodin tai CSS:n lataamisesta), lähetetään pyyntö edelleen osoitteessa <i><a href=\"http://localhost:3001\">http://localhost:3001</a></i> olevalle palvelimelle.</p>\n<p>Nyt myös frontend on kunnossa. Se toimii sekä sovelluskehitysmoodissa että tuotannossa yhdessä palvelimen kanssa.</p>\n<p>Eräs negatiivinen puoli käyttämässämme lähestymistavassa on se, että sovelluksen uuden version tuotantoon vieminen edellyttää erillisessä repositoriossa olevan frontendin koodin tuotantoversion generoimista. Tämä taas hankaloittaa automatisoidun <a href=\"https://martinfowler.com/bliki/DeploymentPipeline.html\">deployment pipelinen</a> toteuttamista. Deployment pipelinellä tarkoitetaan automatisoitua ja hallittua tapaa viedä koodi sovelluskehittäjän koneelta erilaisten testien ja laadunhallinnallisten vaiheiden kautta tuotantoympäristöön.</p>\n<p>Tähänkin on useita erilaisia ratkaisuja (esim. sekä frontendin että backendin <a href=\"https://github.com/mars/heroku-cra-node\">sijoittaminen samaan repositorioon</a>), emme kuitenkaan nyt mene niihin.</p>\n<p>Myös frontendin koodin deployaaminen omana sovelluksenaan voi joissain tilanteissa olla järkevää. <em>create-react-app</em>:in avulla luotujen sovellusten osalta se on <a href=\"https://github.com/mars/create-react-app-buildpack\">suoraviivaista</a>.</p>\n<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-3\">Githubissa</a>, branchissa <i>part3-3</i>.</p>\n<p>Frontendin koodiin tehdyt muutokset ovat the <a href=\"https://github.com/fullstack-hy2020/part2-notes/tree/part3-1\">frontendin repositorion</a> branchissa <i>part3-1</i>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtävät 3.9.-3.11.</h3>\n<p>Seuraavissa tehtävissä koodia ei tarvita montaa riviä. Tehtävät ovat kuitenkin haastavia, sillä nyt on tarkalleen hallittava, missä tapahtuu mitäkin, ja kaikki konfiguraatiot on tehtävä täsmälleen oikein. </p>\n<h4>3.9 puhelinluettelon backend step9</h4>\n<p>Laita backend toimimaan edellisessä osassa tehdyn puhelinluettelon frontendin kanssa muilta osin, paitsi mahdollisen puhelinnumeron muutoksen osalta, jonka vastaava toiminnallisuus toteutetaan backendiin vasta tehtävässä 3.17.</p>\n<p>Joudut todennäköisesti tekemään frontendiin erinäisiä pieniä muutoksia ainakin backendin oletettujen urlien osalta. Muista pitää selaimen konsoli koko ajan auki. Jos jotkut HTTP-pyynnöt epäonnistuvat, kannattaa katsoa <i>Network</i>-välilehdeltä, mitä tapahtuu. Pidä myös silmällä, mitä palvelimen konsolissa tapahtuu. Jos et tehnyt edellistä tehtävää, kannattaa POST-pyyntöä käsittelevässä tapahtumankäsittelijässä tulostaa konsoliin mukana tuleva data eli <i>request.body</i>.</p>\n<h4>3.10 puhelinluettelon backend step10</h4>\n<p>Vie sovelluksen backend internetiin, esim. Herokuun. </p>\n<p><strong>Huom.</strong> komento <em>heroku</em> toimii laitoksen koneilla ja fuksikannettavilla. Jos et jostain syystä saa <a href=\"https://devcenter.heroku.com/articles/heroku-cli\">asennettua</a> herokua koneellesi, voit käyttää komentoa <a href=\"https://www.npmjs.com/package/heroku-cli\">npx heroku-cli</a>.</p>\n<p>Testaa selaimen ja postmanin tai VS Code REST-clientin avulla, että internetissä oleva backend toimii.</p>\n<p><strong>PRO TIP:</strong> kun deployaat sovelluksen Herokuun, kannattaa ainakin alkuvaiheissa pitää <strong>KOKO AJAN</strong> näkyvillä Herokussa olevan sovelluksen loki antamalla komento <em>heroku logs -t</em>.</p>\n<p>Seuraavassa loki eräästä tyypillisestä ongelmatilanteesta, jossa Heroku ei löydä sovelluksen riippuvuutena olevaa moduulia <i>express</i>:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/6e29b/33.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkUlEQVQoz22Q227bMBBEV6YsW7JIUdTNonjXxXYSJ2mRhzy0+YD+/wd15cBoA2QeBiCJ2TlLYD9Ufu7oVdIXKX6H4qeirwOzsj72rTaD1k3b5LrIdMJqsoGv4u+OXXv+psRH6P6cq19efLhika2X1dm2Qy9qnss0k2zXtQnnESH/pZWFToJUoB2EZT1aD70s28YZo7WRshttLzinvIx3O4iif9lomkEbcA6ch8sFlgWWU1zVTd2UZZmmaZZlaEmSwDdaTmCxc4RxgqcrPD7B80vcNIxSylie53RVzhgjhMQ3kbvgoNSGcyg4oFcVCIG+yTIMFEVRihKjBedI8TmIc4736EgEZF4ipcHYFR4p5hmmhQih1U1a9VJqXN4YpfUwDN3xiCP2+/0NG3fGpA8r9vUZHh7R47adp8n7EMbReT/P8zhN1hocVlWVEALht9st7HsJlN6xaygFkkdpiksi3n1nejgcGGWfwOjYjE+wwe9FYPwza+F8WclPp1gI7PHBI+2gVAjBOWetRWzEwfxaC/AXiCoq3p6gHfoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"33\"\n        title=\"33\"\n        src=\"/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/fcda8/33.png\"\n        srcset=\"/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/12f09/33.png 148w,\n/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/e4a3f/33.png 295w,\n/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/fcda8/33.png 590w,\n/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/efc66/33.png 885w,\n/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/c83ae/33.png 1180w,\n/fullstack/static/9c32d4d565c7179d84334ba086ed03b9/6e29b/33.png 1610w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Syynä ongelmalle on se, että <i>expressiä</i> asennettaessa oli unohtunut antaa optio <i>--save</i>, joka tallentaa tiedon riippuvuudesta tiedostoon <i>package.json</i>. </p>\n<p>Toinen tyypillinen ongelma on se, että sovellusta ei ole konfiguroitu käyttämään ympäristömuuttujana <em>PORT</em> määriteltyä porttia:</p>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/ae28e/34.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtklEQVQI123B7W7CIBQA0NuiaQWh0Fs+LhahX8uyOo3+2fu/2RL/Ldk50KzU7pnfsvzZxHPiezouUcTeFWuTk1JqbbpOa+RqEPXhCH/kVN0+q/tev+7s9WDfX9W2mkh5Lsu2ppTmJRENyvpuTI3W9Rt7g3O68mkW60eTJwgEzoMPjerQYCDCHp3tjZGIqJU6ta0Q4sS5UkqcBTCKLBc2zawUyAXiBcaxRQwheO+ttS5QGIYD/OMXsnMQZ+zTEeQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"34\"\n        title=\"34\"\n        src=\"/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/fcda8/34.png\"\n        srcset=\"/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/12f09/34.png 148w,\n/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/e4a3f/34.png 295w,\n/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/fcda8/34.png 590w,\n/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/efc66/34.png 885w,\n/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/c83ae/34.png 1180w,\n/fullstack/static/ca43fb98bc62fbd1d6a918b4d965274e/ae28e/34.png 1598w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<p>Tee repositorion juureen tiedosto README.md ja lisää siihen linkki internetissä olevaan sovellukseesi.</p>\n<h4>3.11 puhelinluettelo full stack</h4>\n<p>Generoi frontendistä tuotantoversio ja lisää se internetissä olevaan sovellukseesi tässä osassa esiteltyä menetelmää noudattaen.</p>\n<p><strong>Huom.</strong> eihän hakemisto <i>build</i> ole gitignoroituna projektissasi?</p>\n<p>Huolehdi myös, että frontend toimii edelleen myös paikallisesti.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/fullstack/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"b","lang":"fi"}}},"pageContext":{"part":3,"letter":"b","lang":"fi"}},"staticQueryHashes":["3128451518"]}