{"componentChunkName":"component---src-templates-content-template-js","path":"/osa4/token_perustainen_kirjautuminen","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Käyttäjien tulee pystyä kirjautumaan sovellukseemme ja muistiinpanot pitää automaattisesti liittää kirjautuneen käyttäjän tekemiksi.</p>\n<p>Toteutamme nyt backendiin tuen <a href=\"https://scotch.io/tutorials/the-ins-and-outs-of-token-based-authentication#toc-how-token-based-works\">token-perustaiselle</a> autentikoinnille.</p>\n<p>Token-autentikaation periaatetta kuvaa seuraava sekvenssikaavio:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/8b2839fe97680c325df6647121af66c3/c211c/16e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAABNElEQVQoz4WS2ZaCQAxE+f8/BAFFFtn3TRaZa0c9yjhn6iHG7lRSqUbbnnAcx3VdyZumORwOhmH0fb99om1b0zS5SpJEG4ahVwjDsCzLm8L1ei2KIsuyeZ535GmauMrzHKKm6zptiL7vL8vyKlrXlbrtGyiTq/vkcRyJTGPyRSGKIiKH0uX2CciiSHvvJy3oReOu69AWBIHneefz+RXxBY2M2ZPfdTKQLpRalmXb9ul0IpLj6/F45GpP5mh5oq5rxGMkc1ghjmP+kuO2CLyT2UHIJOhkAtOkvbyT7CmbS0Tgg5ymKZvQkvV2sv9yG7ceZH6YIK/NU1+eYLi4/Q6R+cVtRuGwSCJWVRUq0ChQkISIbf+7TXsiG/FIGOEpkPB5PmT/Jos2VFDKidjOJwitVkCUkH8AsmDp0n/DvjAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"16e\"\n        title=\"16e\"\n        src=\"/fullstack/static/8b2839fe97680c325df6647121af66c3/fcda8/16e.png\"\n        srcset=\"/fullstack/static/8b2839fe97680c325df6647121af66c3/12f09/16e.png 148w,\n/fullstack/static/8b2839fe97680c325df6647121af66c3/e4a3f/16e.png 295w,\n/fullstack/static/8b2839fe97680c325df6647121af66c3/fcda8/16e.png 590w,\n/fullstack/static/8b2839fe97680c325df6647121af66c3/efc66/16e.png 885w,\n/fullstack/static/8b2839fe97680c325df6647121af66c3/c83ae/16e.png 1180w,\n/fullstack/static/8b2839fe97680c325df6647121af66c3/c211c/16e.png 1502w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>\n<p>Alussa käyttäjä kirjautuu Reactilla toteutettua kirjautumislomaketta käyttäen</p>\n<ul>\n<li>lisäämme kirjautumislomakkeen frontendiin <a href=\"/fullstack/osa5\">osassa 5</a></li>\n</ul>\n</li>\n<li>Tämän seurauksena selaimen React-koodi lähettää käyttäjätunnuksen ja salasanan HTTP POST -pyynnöllä palvelimen osoitteeseen <i>/api/login</i></li>\n<li>\n<p>Jos käyttäjätunnus ja salasana ovat oikein, generoi palvelin <i>tokenin</i>, joka yksilöi jollain tavalla kirjautumisen tehneen käyttäjän</p>\n<ul>\n<li>token on digitaalisesti allekirjoitettu, joten sen väärentäminen on (kryptografisesti) mahdotonta</li>\n</ul>\n</li>\n<li>Backend vastaa selaimelle onnistumisesta kertovalla statuskoodilla ja palauttaa tokenin vastauksen mukana</li>\n<li>Selain tallentaa tokenin esimerkiksi React-sovelluksen tilaan</li>\n<li>Kun käyttäjä luo uuden muistiinpanon (tai tekee jonkin operaation, joka edellyttää tunnistautumista), lähettää React-koodi tokenin pyynnön mukana palvelimelle</li>\n<li>Palvelin tunnistaa pyynnön tekijän tokenin perusteella</li>\n</ul>\n<p>Tehdään ensin kirjautumistoiminto. Asennetaan <a href=\"https://github.com/auth0/node-jsonwebtoken\">jsonwebtoken</a>-kirjasto, jonka avulla koodimme pystyy generoimaan <a href=\"https://jwt.io/\">JSON web token</a> -muotoisia tokeneja.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> jsonwebtoken --save</code></pre></div>\n<p>Tehdään kirjautumisesta vastaava koodi tiedostoon <em>controllers/login.js</em></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> bcrypt <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bcrypt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> loginRouter <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> User <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../models/user'</span><span class=\"token punctuation\">)</span>\n\nloginRouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> username<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>username <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> passwordCorrect <span class=\"token operator\">=</span> user <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span>\n    <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span>\n    <span class=\"token operator\">:</span> <span class=\"token keyword\">await</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span>passwordHash<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>user <span class=\"token operator\">&amp;&amp;</span> passwordCorrect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      error<span class=\"token operator\">:</span> <span class=\"token string\">'invalid username or password'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> userForToken <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    username<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>\n    id<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>userForToken<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token punctuation\">)</span>\n\n  response\n    <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> token<span class=\"token punctuation\">,</span> username<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> loginRouter</code></pre></div>\n<p>Koodi aloittaa etsimällä pyynnön mukana olevaa <i>usernamea</i> vastaavan käyttäjän tietokannasta. Seuraavaksi katsotaan onko pyynnön mukana oleva <i>password</i> oikea. Koska tietokantaan ei ole talletettu salasanaa, vaan salasanasta laskettu <i>hash</i>, tehdään vertailu metodilla <em>bcrypt.compare</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">await</span> bcrypt<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span>passwordHash<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Jos käyttäjää ei ole olemassa tai salasana on väärä, vastataan kyselyyn statuskoodilla <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2\">401 unauthorized</a> ja kerrotaan syy vastauksen bodyssä.</p>\n<p>Jos salasana on oikein, luodaan metodin <em>jwt.sign</em> avulla token, joka sisältää digitaalisesti allekirjoitetussa muodossa käyttäjätunnuksen ja käyttäjän id:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> userForToken <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  username<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>\n  id<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>userForToken<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Token on digitaalisesti allekirjoitettu käyttämällä <i>salaisuutena</i> ympäristömuuttujassa <i>SECRET</i> olevaa merkkijonoa. Digitaalinen allekirjoitus varmistaa sen, että ainoastaan salaisuuden tuntevilla on mahdollisuus generoida validi token. Ympäristömuuttujalle pitää muistaa asettaa arvo tiedostoon <i>.env</i>.</p>\n<p>Onnistuneeseen pyyntöön vastataan statuskoodilla <i>200 ok</i> ja generoitu token sekä kirjautuneen käyttäjän käyttäjätunnus ja nimi lähetetään vastauksen bodyssä pyynnön tekijälle.</p>\n<p>Kirjautumisesta huolehtiva koodi on vielä liitettävä sovellukseen lisäämällä tiedostoon <i>app.js</i> muiden routejen käyttöönoton yhteyteen</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> loginRouter <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./controllers/login'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">//...</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/login'</span><span class=\"token punctuation\">,</span> loginRouter<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Kokeillaan kirjautumista, käytetään VS Coden REST-clientiä:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/0f586/17e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.675675675675674%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoElEQVQY04XOSQ6DMAwF0NyjSTCZB0hLJgFCKtz/Ug3trkLtkxeWLH8bxXjPuVhrlFatcd4D9IzxVuIK51xrPc/LNEVEKHXGb9telzVNj5riOteSkrWWkDb8hjEWQh7Hse9P1ANIZbQLZgijs6NVwRotJQDQKy2RMZbbkyUjduJDWV1aRi3rYHrobhjTn8jbebktax+EcZIzrwRA99cn4gVeXit2FF4FkQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"17e\"\n        title=\"17e\"\n        src=\"/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/fcda8/17e.png\"\n        srcset=\"/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/12f09/17e.png 148w,\n/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/e4a3f/17e.png 295w,\n/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/fcda8/17e.png 590w,\n/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/efc66/17e.png 885w,\n/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/c83ae/17e.png 1180w,\n/fullstack/static/5c4c0fb60e15ec9c753e541a05002c3f/0f586/17e.png 1498w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Kirjautuminen ei kuitenkaan toimi, konsoli näyttää seuraavalta:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">(</span>node:32911<span class=\"token punctuation\">)</span> UnhandledPromiseRejectionWarning: Error: secretOrPrivateKey must have a value\n    at Object.module.exports <span class=\"token punctuation\">[</span>as sign<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/node_modules/jsonwebtoken/sign.js:101:20<span class=\"token punctuation\">)</span>\n    at loginRouter.post <span class=\"token punctuation\">(</span>/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/controllers/login.js:26:21<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span>node:32911<span class=\"token punctuation\">)</span> UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async <span class=\"token keyword\">function</span> without a catch block, or by rejecting a promise <span class=\"token function\">which</span> was not handled with .catch<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>. <span class=\"token punctuation\">(</span>rejection id: <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Ongelman aiheuttaa komento <em>jwt.sign(userForToken, process.env.SECRET)</em> sillä ympäristömuuttujalle <i>SECRET</i> on unohtunut määritellä arvo. Kun arvo (joka saa olla mikä tahansa merkkijono) määritellään tiedostoon <i>.env</i>, alkaa kirjautuminen toimia.</p>\n<p>Onnistunut kirjautuminen palauttaa kirjautuneen käyttäjän tiedot ja tokenin:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/6f175/18ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQY03VRW27EIAzMPRoImPAwEAh5bUmy979WTVf7Uak7gGVhj8YDXQyhlJSmHOMUY1Rq9N5SYrSRIce50DLWDEIISYBRjYjovdfadOv+vWx7yelYlzknAOj7nnMuADhjGmBDfAQs02THkdjDLxhj1NZpi9bH4GywWgFQgb9BUk6p2+HpQ922JedAisE7515tnUHvyh6sSVYzzoc3qEajOoDd+21d9+PIcynLElOipr5njcxpuP6rZw38L4QU5NBKSRMBtIGFoMMptmRo5KbB/wPVyeZ1+Ud19XL1xuvpzxvrhRTTrDv+GaSilDyru09/VHxUtGRD0SXtgd7uI5lctJ8BsKMkfSJoLdt9c8hfLn8A3zBE6D8Pmj0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"18ea\"\n        title=\"18ea\"\n        src=\"/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/fcda8/18ea.png\"\n        srcset=\"/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/12f09/18ea.png 148w,\n/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/e4a3f/18ea.png 295w,\n/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/fcda8/18ea.png 590w,\n/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/efc66/18ea.png 885w,\n/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/c83ae/18ea.png 1180w,\n/fullstack/static/2e2ddac76483e17fded8f6fcc43fd7d4/6f175/18ea.png 2036w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Virheellisellä käyttäjätunnuksella tai salasanalla kirjautuessa annetaan asianmukaisella statuskoodilla varustettu virheilmoitus</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/49fe09c494b9e591fa8811b1772404d5/aea0a/19ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.351351351351354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArUlEQVQY032OaxKDIAyEPYhgAgRCsULx2d7/YI21Y/3VnR2Ygf2SbTjwVOdl3R65rMtcawVApVQnFxqldWJ+RC4plpwNYvuRBLTWDSLy7R5Sn9j37MlZ3XX6FEAm/wr8HIa11tz3HKPYGPOFiWMok8DR2VYJexFAIdqEnJdl28ZpGscxBD4mN3sAQY7uuvBcLL2IojXek7XSWh5+wUb/lfQSxjkwFoh2O0Lx8fsGTtwqO7oDmRAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"19ea\"\n        title=\"19ea\"\n        src=\"/fullstack/static/49fe09c494b9e591fa8811b1772404d5/fcda8/19ea.png\"\n        srcset=\"/fullstack/static/49fe09c494b9e591fa8811b1772404d5/12f09/19ea.png 148w,\n/fullstack/static/49fe09c494b9e591fa8811b1772404d5/e4a3f/19ea.png 295w,\n/fullstack/static/49fe09c494b9e591fa8811b1772404d5/fcda8/19ea.png 590w,\n/fullstack/static/49fe09c494b9e591fa8811b1772404d5/efc66/19ea.png 885w,\n/fullstack/static/49fe09c494b9e591fa8811b1772404d5/c83ae/19ea.png 1180w,\n/fullstack/static/49fe09c494b9e591fa8811b1772404d5/aea0a/19ea.png 2018w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Muistiinpanojen luominen vain kirjautuneille</h3>\n<p>Muutetaan vielä muistiinpanojen luomista siten, että luominen onnistuu ainoastaan jos luomista vastaavan pyynnön mukana on validi token. Muistiinpano talletetaan tokenin identifioiman käyttäjän tekemien muistiinpanojen listaan.</p>\n<p>Tapoja tokenin välittämiseen selaimesta backendiin on useita. Käytämme ratkaisussamme <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization\">Authorization</a>-headeria. Tokenin lisäksi headerin avulla kerrotaan mistä <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#Authentication_schemes\">autentikointiskeemasta</a> on kyse. Tämä voi olla tarpeen, jos palvelin tarjoaa useita eri tapoja autentikointiin. Skeeman ilmaiseminen kertoo näissä tapauksissa palvelimelle, miten mukana olevat kredentiaalit tulee tulkita.\nMeidän käyttöömme sopii <i>Bearer</i>-skeema.</p>\n<p>Käytännössä tämä tarkoittaa, että jos token on esimerkiksi merkkijono <i>eyJhbGciOiJIUzI1NiIsInR5c2VybmFtZSI6Im1sdXVra2FpIiwiaW</i>, laitetaan pyynnöissä headerin Authorization arvoksi merkkijono</p>\n<pre>\nBearer eyJhbGciOiJIUzI1NiIsInR5c2VybmFtZSI6Im1sdXVra2FpIiwiaW\n</pre>\n<p>Muistiinpanojen luominen muuttuu seuraavasti:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getTokenFrom</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">request</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> authorization <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'authorization'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>authorization <span class=\"token operator\">&amp;&amp;</span> authorization<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bearer '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> authorization<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span>\nnotesRouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token function\">getTokenFrom</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> decodedToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>token <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>decodedToken<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> <span class=\"token string\">'token missing or invalid'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>decodedToken<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span></span>\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    content<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    important<span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important<span class=\"token punctuation\">,</span>\n    date<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    user<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>_id\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> savedNote <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  user<span class=\"token punctuation\">.</span>notes <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>notes<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Apufunktio <em>getTokenFrom</em> eristää tokenin headerista <i>authorization</i>. Tokenin oikeellisuus varmistetaan metodilla <em>jwt.verify</em>. Metodi myös dekoodaa tokenin, eli palauttaa olion, jonka perusteella token on laadittu:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> decodedToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Tokenista dekoodatun olion sisällä on kentät <i>username</i> ja <i>id</i> eli se kertoo palvelimelle kuka pyynnön on tehnyt.</p>\n<p>Jos tokenia ei ole tai tokenista dekoodattu olio ei sisällä käyttäjän identiteettiä (eli <em>decodedToken.id</em> ei ole määritelty), palautetaan virheestä kertova statuskoodi <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2\">401 unauthorized</a> ja kerrotaan syy vastauksen bodyssä:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>token <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>decodedToken<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token string\">'token missing or invalid'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Kun pyynnön tekijän identiteetti on selvillä, jatkuu suoritus entiseen tapaan.</p>\n<p>Uuden muistiinpanon luominen onnistuu nyt postmanilla jos <i>authorization</i>-headerille asetetaan oikeanlainen arvo, eli merkkijono <i>bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ</i>, missä loppuosa on <i>login</i>-operaation palauttama token.</p>\n<p>Postmanilla luominen näyttää seuraavalta</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/5d6a0/20e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7UlEQVQY022NaU7DMBCFfREuwtE4ATfgKvzgf0EspZUaukCjKqmyeEu8JGM7tnHCXz49jZ7mPc2gqq5Zi+vsdDnnxbUsixJjzOg/EEIFw18Fv31QN/fi7nFASkoFY/+8E0+vrKOMtEoKqbVSKZnRix8S42gAhIb1Ra9+1Hc9ID0M1jlwzqVyc9Vd6www0aeytWYESKkxxodgrCGEpH4EEXkZFUW4abVUztgY4kyaIWgpOaVpH32I3i8Kk3UA85cpxMlaPzlUvWz5em+ORcxrf66SYt7oXU7eM/KWdZtjvznxzwP72NtDke76PxbzCyfNFqAjHr4oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20e\"\n        title=\"20e\"\n        src=\"/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/fcda8/20e.png\"\n        srcset=\"/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/12f09/20e.png 148w,\n/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/e4a3f/20e.png 295w,\n/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/fcda8/20e.png 590w,\n/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/efc66/20e.png 885w,\n/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/c83ae/20e.png 1180w,\n/fullstack/static/fbedde4a1b76cfc0594778a6833312b2/5d6a0/20e.png 1580w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>ja Visual Studio Coden REST clientillä</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/d498541501c30a9df17ddaad7dcbb609/772aa/21ea.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA90lEQVQY031QbXbEIAjMQeIXCqhRY9LY7Lb3v1cx/b/zfKjAwMByHHstJee0bSVyag/ggUfyte/7XmqRr7FOIG7mmFIi4sVZ9zV+rtd79H6fUkqYzmhl7cyVRyG6Uxy1bMwBQJsJpdS6rosDR1vj2grjHqlG3ggrI4JblZICJ+Jvzq/jvMfordVWc87OWa21dLYQkFtHYvQ+gA3OETiwMyz9O+JV27hGm8xWatXarKuaZPMPSTVWKdEjTi1WPZeMGjyQNw6MSAavxSI6YvDeLvojZPDEcHVqJdQSOALRXIW10lB/JivZbmI/Th53/JbzjnXHqesR+AcxKTxN1mgKhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"21ea\"\n        title=\"21ea\"\n        src=\"/fullstack/static/d498541501c30a9df17ddaad7dcbb609/fcda8/21ea.png\"\n        srcset=\"/fullstack/static/d498541501c30a9df17ddaad7dcbb609/12f09/21ea.png 148w,\n/fullstack/static/d498541501c30a9df17ddaad7dcbb609/e4a3f/21ea.png 295w,\n/fullstack/static/d498541501c30a9df17ddaad7dcbb609/fcda8/21ea.png 590w,\n/fullstack/static/d498541501c30a9df17ddaad7dcbb609/efc66/21ea.png 885w,\n/fullstack/static/d498541501c30a9df17ddaad7dcbb609/c83ae/21ea.png 1180w,\n/fullstack/static/d498541501c30a9df17ddaad7dcbb609/772aa/21ea.png 2042w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Poikkeusten käsittely</h3>\n<p>Tokenin verifiointi voi myös aiheuttaa poikkeuksen <i>JsonWebTokenError</i>. Jos esim. poistetaan tokenista pari merkkiä, ja yritetään luoda muistiinpano, tapahtuu seuraavasti</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">JsonWebTokenError: invalid signature\n    at /Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/node_modules/jsonwebtoken/verify.js:126:19\n    at getSecret <span class=\"token punctuation\">(</span>/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/node_modules/jsonwebtoken/verify.js:80:14<span class=\"token punctuation\">)</span>\n    at Object.module.exports <span class=\"token punctuation\">[</span>as verify<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/node_modules/jsonwebtoken/verify.js:84:10<span class=\"token punctuation\">)</span>\n    at notesRouter.post <span class=\"token punctuation\">(</span>/Users/mluukkai/opetus/_2019fullstack-koodit/osa3/notes-backend/controllers/notes.js:40:30<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Syynä tokenin dekoodaamisen aiheuttamalle virheelle on monia. Token voi olla viallinen, kuten esimerkissämme, väärennetty tai eliniältään vanhentunut. Laajennetaan virheidenkäsittelymiddlewarea huomioimaan tokenin dekoodaamisen aiheuttamat virheet</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      error<span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'ValidationError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      error<span class=\"token operator\">:</span> error<span class=\"token punctuation\">.</span>message \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'JsonWebTokenError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      error<span class=\"token operator\">:</span> <span class=\"token string\">'invalid token'</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>  <span class=\"token punctuation\">}</span>\n\n  logger<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part4-9\">githubissa</a>, branchissä <i>part4-9</i>.</p>\n<p>Jos sovelluksessa on useampia rajapintoja jotka vaativat kirjautumisen, kannattaa JWT:n validointi eriyttää omaksi middlewarekseen, tai käyttää jotain jo olemassa olevaa kirjastoa kuten <a href=\"https://www.npmjs.com/package/express-jwt\">express-jwt</a>.</p>\n<h3>Loppuhuomioita</h3>\n<p>Koodissa on tapahtunut paljon muutoksia ja matkan varrella on tapahtunut tyypillinen kiivaasti etenevän ohjelmistoprojektin ilmiö: suuri osa testeistä on hajonnut. Koska kurssin tämä osa on jo muutenkin täynnä uutta asiaa, jätämme testien korjailun vapaaehtoiseksi harjoitustehtäväksi.</p>\n<p>Käyttäjätunnuksia, salasanoja ja tokenautentikaatiota hyödyntäviä sovelluksia tulee aina käyttää salatun <a href=\"https://en.wikipedia.org/wiki/HTTPS\">HTTPS</a>-yhteyden yli. Voimme käyttää sovelluksissamme Noden <a href=\"https://nodejs.org/docs/latest-v8.x/api/http.html\">HTTP</a>-serverin sijaan <a href=\"https://nodejs.org/api/https.html\">HTTPS</a>-serveriä (se vaatii lisää konfiguraatiota). Toisaalta koska sovelluksemme tuotantoversio on Herokussa, sovelluksemme pysyy käyttäjien kannalta suojattuna sen ansiosta, että Heroku reitittää kaiken liikenteen selaimen ja Herokun palvelimien välillä HTTPS:n yli.</p>\n<p>Toteutamme kirjautumisen frontendin puolelle kurssin <a href=\"/fullstack/osa5\">seuraavassa osassa</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Tehtävät 4.15.-4.22.</h3>\n<p>Seuraavien tehtävien myötä Blogilistalle luodaan käyttäjienhallinnan perusteet. Varminta on seurata melko tarkkaan osan 4 luvusta <a href=\"/fullstack/osa4/kayttajien_hallinta\">Käyttäjien hallinta</a> ja <a href=\"/fullstack/osa4/token_perustainen_kirjautuminen\">Token-perustainen kirjautuminen</a> etenevää tarinaa. Toki luovuus on sallittua.</p>\n<p><strong>Varoitus vielä kerran:</strong> jos huomaat kirjoittavasi sekaisin async/awaitia ja <em>then</em>-kutsuja, on 99% varmaa, että teet jotain väärin. Käytä siis jompaa kumpaa tapaa, älä missään tapauksessa \"varalta\" molempia.</p>\n<h4>4.15: blogilistan laajennus, step4</h4>\n<p>Tee sovellukseen mahdollisuus luoda käyttäjiä tekemällä HTTP POST -pyyntö osoitteeseen <i>api/users</i>. Käyttäjillä on <i>käyttäjätunnus, salasana ja nimi</i>.</p>\n<p>Älä talleta tietokantaan salasanoja selväkielisenä vaan käytä osan 4 luvun <a href=\"/fullstack/osa4/kayttajien_hallinta#kayttajien-luominen\">Käyttäjien luominen</a> tapaan <i>bcrypt</i>-kirjastoa.</p>\n<p><strong>HUOM</strong> joillain windows-käyttäjillä on ollut ongelmia <i>bcryptin</i> kanssa. Jos törmäät ongelmiin, poista kirjasto komennolla</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> uninstall bcrypt --save </code></pre></div>\n<p>ja asenna sen sijaan <a href=\"https://www.npmjs.com/package/bcryptjs\">bcryptjs</a></p>\n<p>Tee järjestelmään myös mahdollisuus katsoa kaikkien käyttäjien tiedot sopivalla HTTP-pyynnöllä.</p>\n<p>Käyttäjien lista voi näyttää esim. seuraavalta:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/b59bda1bd7e5987a5c805332d509e516/9685e/22.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAs0lEQVQY042PyRKCMAyGef+Hw4NelEGQfYe2NKkNBcOMN8eBL9sh+ZOJZ60lImPMOIkkzaI4KeumqOq67dSsZw2/rgGFVDzvsdg5t23byrjdnVsX92X9D3c9LgAYBEFWZN3c5lNuye672I7wOKSUURyXokzH5NlFpaga1SijjsULESKatwEAWggsct7OsV9WSvn+5Z484uF1LW5hG/ZzjxaPxfwzAmiGtEA54dTrboDhjPgDrneXjiA1Ia4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"22\"\n        title=\"22\"\n        src=\"/fullstack/static/b59bda1bd7e5987a5c805332d509e516/fcda8/22.png\"\n        srcset=\"/fullstack/static/b59bda1bd7e5987a5c805332d509e516/12f09/22.png 148w,\n/fullstack/static/b59bda1bd7e5987a5c805332d509e516/e4a3f/22.png 295w,\n/fullstack/static/b59bda1bd7e5987a5c805332d509e516/fcda8/22.png 590w,\n/fullstack/static/b59bda1bd7e5987a5c805332d509e516/efc66/22.png 885w,\n/fullstack/static/b59bda1bd7e5987a5c805332d509e516/c83ae/22.png 1180w,\n/fullstack/static/b59bda1bd7e5987a5c805332d509e516/9685e/22.png 1336w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>4.16*: blogilistan laajennus, step5</h4>\n<p>Laajenna käyttäjätunnusten luomista siten, että käyttäjätunnuksen sekä salasanan tulee olla olemassa ja vähintään 3 merkkiä pitkiä. Käyttäjätunnuksen on oltava järjestelmässä uniikki.</p>\n<p>Luomisoperaation tulee palauttaa sopiva statuskoodi ja jonkinlainen virheilmoitus, jos yritetään luoda epävalidi käyttäjä.</p>\n<p><strong>HUOM</strong> älä testaa salasanaan liittyviä ehtoja Mongoosen validointien avulla, se ei ole hyvä idea, sillä backendin vastaanottama salasana ja kantaan tallennettu salasanan tiiviste eivät ole sama asia. Salasanan oikeellisuus kannattaa testata kontrollerissa samoin kun teimme <a href=\"/fullstack/osa3/validointi_ja_es_lint\">osassa 3</a> ennen validointien käyttöönottoa.</p>\n<p>Tee myös testit, jotka varmistavat, että virheellisiä käyttäjiä ei luoda, ja että virheellisen käyttäjän luomisoperaatioon vastaus on järkevä statuskoodin ja virheilmoituksen osalta.</p>\n<h4>4.17: blogilistan laajennus, step6</h4>\n<p>Laajenna blogia siten, että blogiin tulee tieto sen lisänneestä käyttäjästä.</p>\n<p>Muokkaa blogien lisäystä osan 4 luvun <a href=\"/fullstack/osa4/kayttajien_hallinta#populate\">populate</a> tapaan siten, että blogin lisäämisen yhteydessä määritellään blogin lisääjäksi <i>joku</i> järjestelmän tietokannassa olevista käyttäjistä (esim. ensimmäisenä löytyvä). Tässä vaiheessa ei ole väliä kuka käyttäjistä määritellään lisääväksi. Toiminnallisuus viimeistellään tehtävässä 4.19.</p>\n<p>Muokaa kaikkien blogien listausta siten, että blogien yhteydessä näytetään lisääjän tiedot:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/199682ad74f50747c90997a967856ffa/ae28e/23e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRklEQVQoz42RW28CIRCF/f8/ztc2tl1b5c7qcllggAU71rQxdR+cHC4hczjhY5NzrrXGmISUhDI1nqTWk3UxQUjpqvg7P2iTAEopeEVOpcICMSdUgHh1QAoZT4KP2HN5qA2Oz/3+9WV3FGz3NXwRJtQo1cilMufZn+NsUnBQ8pq59+asfdu9Mcl00GIWta30LcuyYsbT1hujjGhCDBnGPZnoFKbWWr8r5NL75XLTXXJXUnItJjAWJlecAZNb/p/c1pLTT8WUnPXOzihrPRIKHoLH16bbJnoAhBcKcv1LvwJjjL2/D0fJBnr4pEeuFJMKgXEhCedEiAOnQmkkh8Jb+r35dDptt9uBfBzsgXp6ebo2t2XUo7aaGsotn6IxyfTe/7WuAMOhlWZS2OQ9eJ9nB662+lQyflWtCxRkEWJJUCHWiJ/3jPkbj1e3MLKPY0IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"23e\"\n        title=\"23e\"\n        src=\"/fullstack/static/199682ad74f50747c90997a967856ffa/fcda8/23e.png\"\n        srcset=\"/fullstack/static/199682ad74f50747c90997a967856ffa/12f09/23e.png 148w,\n/fullstack/static/199682ad74f50747c90997a967856ffa/e4a3f/23e.png 295w,\n/fullstack/static/199682ad74f50747c90997a967856ffa/fcda8/23e.png 590w,\n/fullstack/static/199682ad74f50747c90997a967856ffa/efc66/23e.png 885w,\n/fullstack/static/199682ad74f50747c90997a967856ffa/c83ae/23e.png 1180w,\n/fullstack/static/199682ad74f50747c90997a967856ffa/ae28e/23e.png 1598w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>ja käyttäjien listausta siten että käyttäjien lisäämät blogit ovat näkyvillä</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/9f9a4/24e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAABQElEQVQoz5WS2XKDMAxF+f/vS0ObNqQBjDEGg/cVp0ral6Yb1Vy/yHNHZ65UeB/WtDrnejI0LSID7ek4slkZ+1X6s4oQYrjV5f9VwJNSUjooKY1yWjotrFi0klZyLYXW4to0ylvtc873ZqiU0m63q5rXsj2UzaHpOzwSgB/n2YLt5nQm/GCOSUnFHZ8tW9wivFBB5kv+G5v0pHws8YKbpcUc+/iBB+bf/UVeV8ElEwwLDOpERxW10W4KDPYkAZjz7//zvfKar7qhXbFjjEqp0+nUYXJG6NyiFuGBTAgT3FPUkQbhtutrhIZ+EpPhk9bSfkq7OlY1rZ/p4Uir81RPinnYfopwB5BCSMFFD2PuJxtjGGMheh11ygk6a17jGjcdCcb44Wl/pC/7fj8IutjFRbcpMMCCwCEIGPUuIITJW8xv0RPzkGNnCqEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"24e\"\n        title=\"24e\"\n        src=\"/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/fcda8/24e.png\"\n        srcset=\"/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/12f09/24e.png 148w,\n/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/e4a3f/24e.png 295w,\n/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/fcda8/24e.png 590w,\n/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/efc66/24e.png 885w,\n/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/c83ae/24e.png 1180w,\n/fullstack/static/ac9967c89785b33440e9b1b4e87c17e5/9f9a4/24e.png 1560w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>4.18: blogilistan laajennus, step7</h4>\n<p>Toteuta osan 4 luvun <a href=\"/fullstack/osa4#/token_perustainen_kirjautuminen\">Token-perustainen kirjautuminen</a> tapaan järjestelmään token-perustainen autentikointi.</p>\n<h4>4.19: blogilistan laajennus, step8</h4>\n<p>Muuta blogien lisäämistä siten, että se on mahdollista vain, jos lisäyksen tekevässä HTTP POST -pyynnössä on mukana validi token. Tokenin haltija määritellään blogin lisääjäksi.</p>\n<h4>4.20*: blogilistan laajennus, step9</h4>\n<p>Osan 4 <a href=\"/fullstack/osa4/token_perustainen_kirjautuminen#muistiinpanojen-luominen-vain-kirjautuneille\">esimerkissä</a> token otetaan headereista apufunktion <em>getTokenFrom</em> avulla.</p>\n<p>Jos käytit samaa ratkaisua, refaktoroi tokenin erottaminen <a href=\"/fullstack/osa3/node_js_ja_express#middlewaret\">middlewareksi</a>, joka ottaa tokenin <i>Authorization</i>-headerista ja sijoittaa sen <i>request</i>-olion kenttään <i>token</i>.</p>\n<p>Eli kun rekisteröit middlewaren ennen routeja tiedostossa <i>app.js</i></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>middleware<span class=\"token punctuation\">.</span>tokenExtractor<span class=\"token punctuation\">)</span></code></pre></div>\n<p>pääsevät routet tokeniin käsiksi suoraan viittaamalla <em>request.token</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">blogsRouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ..</span>\n  <span class=\"token keyword\">const</span> decodedToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// ..</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Muista, että normaali  <a href=\"/fullstack/osa3/node_js_ja_express#middlewaret\">middleware</a> on funktio, jolla on kolme parametria, ja joka kutsuu lopuksi parametrina next olevaa funktiota:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">tokenExtractor</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// tokenin ekstraktoiva koodi</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>4.21*: blogilistan laajennus, step10</h4>\n<p>Muuta blogin poistavaa operaatiota siten, että poisto onnistuu ainoastaan jos poisto-operaation tekijä (eli se kenen token on pyynnön mukana) on sama kuin blogin lisääjä.</p>\n<p>Jos poistoa yritetään ilman tokenia tai väärän käyttäjän toimesta, tulee operaation palauttaa asiaan kuuluva statuskoodi.</p>\n<p>Huomaa, että jos haet blogin tietokannasta</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> blog <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Blog<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ei kenttä <i>blog.user</i> ole tyypiltään merkkijono vaan <i>object</i>. Eli jos haluat verrata kannasta haetun olion id:tä merkkijonomuodossa olevaan id:hen, ei normaali vertailu toimi. Kannasta haettu id tulee muuttaa vertailua varten merkkijonoksi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> blog<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> userid<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">...</span></code></pre></div>\n<!---\nnote left of kayttaja\n  käyttäjä täyttää kirjautumislomakkeelle\n  käyttäjätunnuksen ja salasanan\nend note\nkayttaja -> selain: painetaan login-nappia\n\nselain -> backend: HTTP POST /api/login {username, password}\nnote left of backend\n  backend generoi käyttäjän identifioivan TOKENin\nend note\nbackend -> selain: TOKEN palautetaan vastauksen bodyssä\nnote left of selain\n  selain tallettaa TOKENin\nend note\nnote left of kayttaja\n  käyttäjä luo uden muistiinpanon\nend note\nkayttaja -> selain: painetaan create note -nappia\nselain -> backend: HTTP POST /api/notes {content} headereissa TOKEN\nnote left of backend\n  backend tunnistaa TOKENin perusteella kuka käyttää kyseessä\nend note\n\nbackend -> selain: 201 created\n\nkayttaja -> kayttaja:\n-->\n<h4>4.22*: blogilistan laajennus, step11</h4>\n<p>Token-kirjautumisen lisääminen valitettavasti hajotti blogien lisäämiseen liittyvät testit. Korjaa testit. Tee myös testi, joka varmistaa että uuden blogin lisäys ei onnistu, ja pyyntö palauttaa oikean statuskoodin <i>401 Unauthorized</i> jos pyynnön mukana ei ole tokenia.</p>\n<p>Tarvitset luultavasti <a href=\"https://github.com/visionmedia/supertest/issues/398\">tätä</a> tietoa tehtävää tehdessä.</p>\n<p>Tämä oli osan viimeinen tehtävä ja on aika pushata koodi githubiin sekä merkata tehdyt tehtävät <a href=\"https://studies.cs.helsinki.fi/stats/courses/fullstackopen\">palautussovellukseen</a>.</p>\n</div>","frontmatter":{"mainImage":{"publicURL":"/fullstack/static/f800638504cdf371a12947fc31d52030/part-4.svg"},"part":4,"letter":"d","lang":"fi"}}},"pageContext":{"part":4,"letter":"d","lang":"fi"}},"staticQueryHashes":["3128451518"]}